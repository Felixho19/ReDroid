# DSM Patcher

## Introduction

This folder contains the utilities of ReDroid for automatically generating and applying DSM's. DSM (dynamic state modification) is a word borrowed from [this paper][emu-paper], which stands for modifying a program's control flow during runtime. By applying DSM's to malware equipped with anti-sandbox techniques, one can expose its real behavior in emulated environment, which is necessary for many dynamic analysis techniques.

In ReDroid, return values of critical methods are monitored and collected on both real devices and emulators. After that, a heuristic algorithm is applied to the results in order to construct DSM's, that is, replace the return value of certain method during runtime. Finally, the DSM's are uploaded to the emulator and used by ReDroid Xposed module, which is responsible for hooking methods specified in DSM's.

## Usage

Utilities in `scripts` folder are called with corresponding config files in `configs` folder specified. Config file samples are provided in `configs` folder.

In `app/dsm_patcher` folder there is ReDroid's Xposed module.

1. scripts/trace_monitor.py

        $ python scripts/trace_monitor.py -c configs/trace_monitor_config.json

    This utility makes use of JDWP to collect return values of critical methods of certain app. UI events are generated according to DroidBot results. Configured by `trace_monitor_config.json`:

        {
            "real_device_id": <real-device's-device-id>,
            "emulator_id": <emulator's-device-id>,
            "trace_comparator_out_dir": <trace_comparator.py's-output-folder>,
            "apk_dir": <path-to-the-folder-containing-apks>,
            "output_dir": <output-directory>,
            "divergence_threshold": <heuristic-number>,
            "irrelevant_packages": # hint for irrelevant code during comparison
            {
                "jars": <list-of-path-to-irrelevant-jars>
                "names": <list-of-irrelevant-package-names>
                "libs": <path-to-libradar's-lib_packages.csv>
            }
        }

    The `divergence_threshold` config is a heuristic number to control whether a method is critical. **This config is useless by now for related algorithm is not implemented yet.**

    See `configs/trace_monitor_config.json` for example.

2. scripts/dsm_generator.py

        $ python scripts/dsm_generator.py -c configs/dsm_generator_config.json

    This utility applies a heuristic algorithm to the results generated by `trace_monitor.py`, generating DSM's. Configured by `dsm_generator_config.json`:

         {
            "real_device_droidbot_out_dir": <path-to-droidbot-output-for-real-device>,
            "emulator_droidbot_out_dir": <path-to-droidbot-output-for-emulator>,
            "monitor_out": <trace_monitor.py's-output-folder>
            "output_dir": <output-directory>
            "process_num": <max-process-num-python-can-spawn>,
            "irrelevant_packages": # hint for irrelevant code during comparison
            {
                "jars": <list-of-path-to-irrelevant-jars>
                "names": <list-of-irrelevant-package-names>
                "libs": <path-to-libradar's-lib_packages.csv>
            }
        }

    See `configs/dsm_generator_config.json` for example.

3. app/dsm_patcher

    This is the source of ReDroid's Xposed module, an Android Studio project. This module reads `/data/system/ReDroid/dsm.json` as DSM's and apply them.

    The DSM (`dsm.json`) format goes like the following:

        [
            {
                "emuReturnType": <return-type-in-emulator>,
                "emuReturnValue": <return-value-in-emulator>,
                "stackTrace": <runtime-stack-trace>
                "returnValue": <return-type-to-assign>,
                "returnType": <return-value-to-assign>,
                "classMethodName": <full-name-of-the-method>,
                "paraList": <list-of-parameter-types>
            },
            ...
        ]

    See `configs/dsm.json` for example.

[emu-paper]: http://bitblaze.cs.berkeley.edu/papers/VMSec02-kang.pdf
