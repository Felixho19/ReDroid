# marshmallow_modifications

## Introduction

This folder contains several modifications and enhancements on Android system for implementing ReDroid system. The modifications are presented as git patch files.

**Note: Files in this folder should be used only if one wants to build and configure Android image from source. For common usage of ReDroid, please use the [prebuilt images][prebuilt-imgs] (for VirtualBox and Google Nexus 5).**

## Prebuilt Image Usage

There are two folders in the archive:

1. `android-x86`: Import the `android-x96-anti-sandbox.ova` file in the folder to VirtualBox directly.

2. `hammerhead`: These are the images built for Google Nexus 5. Use `adb reboot bootloader` and `fastboot flashall -w` to flash them into your Google Nexus 5.

**Note that one can build & configure images for any other devices that supported by AOSP branch `android-6.0.1_r77`.**

## Description

### Patch files

All patch files are under `patches` folder, having name `0001-anti-sandbox-patch.patch`. They are generated by `generate_patch.sh`, keeping the project's origin folder structure. To apply a patch file, just copy it to the project's corresponding folder and apply it.

[AOSP][aosp] patches are under `patches/aosp` folder:

1. `build/`: Enable debugging for user mode in order to launch ReDroid's JDWP monitor without exposing debug mode features to anti-sandbox techniques.
2. `frameworks/base/`: Expand trace log buffer and hide `isDebuggerConnected` from possible anti-sandbox techniques.
3. `system/core/`: Always allow USB debugging in user mode.

[Android x86][andx86] patches are under `patches/android-x86` folder:

### Other files

1. `generate_patch.sh`: generate patches from original source repos. Modify the project paths to your own version in the script before using.

2. `libs/houdini.sfs`: Intel's support library for ARM native code. Used by Android x86 virtual machine if one wants to run ReDroid on apps with ARM native part.

## Build & Configure Instruction

1. Prepare related repo:
    * [AOSP][aosp] branch `android-6.0.1_r77`
    * [Android x86][andx86] branch `android-x86-6.0-r3`

2. Apply patch files and build Android image

    * Real Device

        1. Apply patches in `aosp` folder to [AOSP source][aosp] branch `android-6.0.1_r77` according to the description part
        2. Select the build target as `user` mode on real device, e.g. `aosp_hammerhead-userdebug`
        3. Build the ROM
        4. Flash the ROM into your device

    * Emulator

        1. Apply patches in `android-x86` folder to [Android x86 source][andx86] branch `android-x86-6.0-r3` according to the description part
        2. Select the build target as `android_x86-eng`
        3. Build the ISO
        4. Create a new Virtual Machine in VirtualBox according to the [official documents][andx86_vb]
        5. Create a custom video mode by

            `$ VBoxManage setextradata <your_vm_name> "CustomVideoMode1" "768x1280x32"`

        6. Set the VM's network to bridged mode
        7. Boot from the ISO in VirtualBox and (optional) install Android x86 on hard disk. To enable ADB connection, use

            `$ adb connect <vm_ip>:5555`

            One can get Android VM's ip by ALT+F7 and `ifconfig`.

        8. Enable `App Compatibility` in settings
        9. Push the `houdini.sfs` in `libs` onto `/sdcard/` folder in the VM. Then in ADB shell, run

            `$ enable_nativebridges`

            This should enable ARM native code support on x86 VM.

[prebuilt-imgs]: https://www.dropbox.com/s/yieoxl9i4chzg4x/ReDroid_img.tar.gz?dl=0
[aosp]: https://source.android.com/
[andx86]: http://www.android-x86.org/
[andx86_vb]: http://www.android-x86.org/documents/virtualboxhowto
